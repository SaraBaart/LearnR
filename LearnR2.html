<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Advanced options</title>

<script src="site_libs/header-attrs-2.11/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>








<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Beginner guide to R</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li>
  <a href="LearnR.html">Getting started</a>
</li>
<li>
  <a href="LearnR2.html">Advanced options</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/SaraBaart">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://twitter.com/SaraBaart">
    <span class="fab fa-twitter fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://www.linkedin.com/in/sara-baart-8109a422/">
    <span class="fab fa-linkedin fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Advanced options</h1>

</div>


<div id="overview" class="section level2">
<h2>Overview</h2>
<p>The topics in this document are:</p>
<ul>
<li><p><a href="#datamanagement2">Data management 2</a></p></li>
<li><p><a href="#graphs2">Advanced graphs</a></p></li>
<li><p><a href="#survival">Survival analysis</a></p></li>
<li><p><a href="#mixedmodels">Mixed effects models</a></p></li>
</ul>
</div>
<div id="datamanagement2" class="section level2">
<h2>Data management 2</h2>
<p>We can do a lot of calculations and data manipulations with R. First of all, we can use R as a calculator:</p>
<pre class="r"><code>2 + 4</code></pre>
<pre><code>## [1] 6</code></pre>
<p>We can save the result as an <em>object</em> in R. Then it is displayed in the upper right pane. With <code>&lt;-</code> we assign an object</p>
<pre class="r"><code>x &lt;- 2 + 4
x</code></pre>
<pre><code>## [1] 6</code></pre>
<p> </p>
<div id="vectors" class="section level5">
<h5>Vectors</h5>
<p>Vectors are a series of different values. With <code>c()</code> we can combine elements into a vector. Let’s say I want to make a vector “v” with 4 values; 1,2,3,4.</p>
<pre class="r"><code>v &lt;- c(1,2,3,4)
v</code></pre>
<pre><code>## [1] 1 2 3 4</code></pre>
<pre class="r"><code>class(v)</code></pre>
<pre><code>## [1] &quot;numeric&quot;</code></pre>
<p>Since the elements of “v” are numbers, the class is numeric. I can also make a vector of text elements. In that case, the class of the vector will be “character”.</p>
<pre class="r"><code>v2 &lt;- c(&quot;Monday&quot;, &quot;Tuesday&quot;, &quot;Wednesday&quot;, &quot;Friday&quot;)
v2</code></pre>
<pre><code>## [1] &quot;Monday&quot;    &quot;Tuesday&quot;   &quot;Wednesday&quot; &quot;Friday&quot;</code></pre>
<pre class="r"><code>class(v2)</code></pre>
<pre><code>## [1] &quot;character&quot;</code></pre>
<p>The function <code>c()</code> can also be used to combine two vectors.</p>
<pre class="r"><code>v3 &lt;- c(v,v2)
v3</code></pre>
<pre><code>## [1] &quot;1&quot;         &quot;2&quot;         &quot;3&quot;         &quot;4&quot;         &quot;Monday&quot;    &quot;Tuesday&quot;  
## [7] &quot;Wednesday&quot; &quot;Friday&quot;</code></pre>
<pre class="r"><code>class(v3)</code></pre>
<pre><code>## [1] &quot;character&quot;</code></pre>
<p>Notice how all the elements of v3 are now strings.</p>
<p>   </p>
</div>
<div id="matrices-and-data-frames" class="section level5">
<h5>Matrices and data frames</h5>
<p>A matrix is a two dimensional vector. We can make a matrix with the function <code>matrix()</code>.</p>
<pre class="r"><code>m1 &lt;- matrix(c(1:9), nrow = 3)
m1</code></pre>
<pre><code>##      [,1] [,2] [,3]
## [1,]    1    4    7
## [2,]    2    5    8
## [3,]    3    6    9</code></pre>
<pre class="r"><code>class(m1)</code></pre>
<pre><code>## [1] &quot;matrix&quot; &quot;array&quot;</code></pre>
<p>The matrix <code>m1</code> is filled with the number 1 through 9 (with <code>c(1:9)</code> I make a sequence of numbers). The matrix is filled in vertically. By specifying <code>nrow = 3</code> R knows how many rows I want. Now compare this with the following matrix:</p>
<pre class="r"><code>m2 &lt;- matrix(c(1:9), nrow = 3, byrow = TRUE)
m2</code></pre>
<pre><code>##      [,1] [,2] [,3]
## [1,]    1    2    3
## [2,]    4    5    6
## [3,]    7    8    9</code></pre>
<p>Can you guess what <code>byrow = TRUE</code> does?</p>
<p> </p>
<p>For our data sets, we often use the class <code>data.frame</code>. I can make my matrix into a data frame:</p>
<pre class="r"><code>data2 &lt;- as.data.frame(m2)
data2</code></pre>
<pre><code>##   V1 V2 V3
## 1  1  2  3
## 2  4  5  6
## 3  7  8  9</code></pre>
<pre class="r"><code>class(data2)</code></pre>
<pre><code>## [1] &quot;data.frame&quot;</code></pre>
<p>You can also build your data set by combining vectors using the <code>cbind()</code> function:</p>
<pre class="r"><code>data3 &lt;- as.data.frame(cbind(v, v2))
data3</code></pre>
<pre><code>##   v        v2
## 1 1    Monday
## 2 2   Tuesday
## 3 3 Wednesday
## 4 4    Friday</code></pre>
<p><strong>Note</strong> Notice the difference between <code>data3</code> and the vector <code>v3</code> we created earlier.</p>
<p> </p>
<p>Certain row numbers or colum numbers can be accessed using the square brackets <code>[,]</code>. A number before the comma gives this row number. This code gives me the first row:</p>
<pre class="r"><code> mtcars[1,] </code></pre>
<pre><code>##           mpg cyl disp  hp drat   wt  qsec vs am gear carb
## Mazda RX4  21   6  160 110  3.9 2.62 16.46  0  1    4    4</code></pre>
<p> </p>
<p>A number after the comma shows this column number (or variable number). Here we show the second column:</p>
<pre class="r"><code> mtcars[,2] </code></pre>
<pre><code>##  [1] 6 6 4 6 8 6 8 4 4 6 6 8 8 8 8 8 8 4 4 4 4 8 8 8 8 4 4 4 8 6 8 4</code></pre>
<p> </p>
</div>
<div id="transform-data-from-wide-to-long-format" class="section level5">
<h5>Transform data from wide to long format</h5>
<p> </p>
<p>For analyses of data sets with repeated measurements the data need to be in the so-called “long” format instead of the “wide” format. Data are in wide format if each patient has one row and the repeated measurements are different variables. Data are in the long format if there is one variable for the repeated measurement, and a patient has multiple rows.</p>
<p>The following dataset <code>data_wide</code> is in the wide format.</p>
<pre class="r"><code>head(data_wide)</code></pre>
<pre><code>##   id group  M_1  M_2  M_3  M_4
## 1  1     1 27.5 20.1 26.9 20.8
## 2  2     1 19.1 20.9 22.7 19.1
## 3  3     1 24.4 19.1 22.6 25.3
## 4  4     1 24.0 13.3 26.6 15.5
## 5  5     1 21.6 19.5 20.0 20.7
## 6  6     2 13.0 29.7 20.9 28.5</code></pre>
<p>It has 10 patients and 6 variables. The variables <code>M_1, M_2, M_3, M_4</code> are a continuous marker, measured at 4 time points.</p>
<p>Using the library <code>data.table</code> and the function <code>melt()</code> we can transform the wide data into long. The melt function has a few important options: <code>id</code> are the variables that are not time-varying, such as a baseline covariate. <code>measure</code> is the variable that is time-varying. There can be multiple repeated measurements. Using the function <code>patterns()</code>, all variables including <code>M</code> will be included as the repeated measure, so I do not need to type <code>c(M_1, M_2, M_3, M_4)</code>. With <code>value.name</code> the repeated variable is given a new name and <code>variable.name</code> tells us which measurement it is.</p>
<pre class="r"><code>library(data.table) 
data_long &lt;- melt(setDT(data_wide), id = c(&#39;id&#39;, &#39;group&#39;),
                  measure = patterns(&quot;M&quot;), 
                  value.name = c(&#39;M&#39;), variable.name = &quot;Time&quot;)

levels(data_long$Time) &lt;-  c(1, 2, 3, 4)

data_long &lt;- data_long[order(data_long$id),]
head(data_long)</code></pre>
<pre><code>##    id group Time    M
## 1:  1     1    1 27.5
## 2:  1     1    2 20.1
## 3:  1     1    3 26.9
## 4:  1     1    4 20.8
## 5:  2     1    1 19.1
## 6:  2     1    2 20.9</code></pre>
<p> </p>
</div>
<div id="dplyr" class="section level4">
<h4>dplyr</h4>
<p>Cheatsheet for the dplyr package from the tidyverse:</p>
<p><a href="https://nyu-cdsc.github.io/learningr/assets/data-transformation.pdf" class="uri">https://nyu-cdsc.github.io/learningr/assets/data-transformation.pdf</a></p>
</div>
</div>
<div id="graphs2" class="section level2">
<h2>Advanced graphs</h2>
<p>Coming soon!</p>
<p>   </p>
</div>
<div id="survival" class="section level2">
<h2>Survival analysis</h2>
<p>A comprehensive guide to survival analysis in R can be found here: <a href="https://www.drizopoulos.com/courses/emc/survival%20analysis%20in%20r%20companion">Survival Analysis in R Companion - By Dimitris Rizopoulos</a></p>
</div>
<div id="mixedmodels" class="section level2">
<h2>Mixed effects models</h2>
<div id="mixed-models-in-general" class="section level3">
<h3>Mixed models in general</h3>
<p>One of the assumptions of (linear) regression models is that the observations are independent of each other. This assumptions does not hold in situations of <em>clustered</em> or <em>hierarchical</em> data.</p>
<p>In multicenter studies, patients are clustered within centers of the study. In longitudinal studies with repeated measurements per patient, observations from one patient are clustered in that patient. This can influence the analyses of a study, because observations <em>within</em> a cluster might be more correlated than observation <em>between</em> different clusters.</p>
<p>One framework possible for clustered is the mixed effects model. This is regression model that combines <strong>fixed</strong> (or population) effects with <strong>random</strong> (or subject-specific) effects.</p>
<p>The graph below visualizes a mixed effects model for repeated measures on two patients (Subject 1 and Subject 2). The thick black line is the population effect estimated by the fixed effects. Through the random effects, every patient has a specific intercept and slope indicated by the dashed lines.</p>
<p><img src="LearnR2_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<p> </p>
<p> </p>
</div>
<div id="install-the-packages" class="section level3">
<h3>Install the package(s)</h3>
<p>Two libraries are used most often for mixed effects models in R; <code>nlme</code> and <code>lme4</code>. Here I will use <code>lme4</code>for the analyses, however a data set available in <code>nlme</code> is used as an example.</p>
<pre class="r"><code>install.packages(lme4)
install.packages(nlme)</code></pre>
<pre class="r"><code>library(lme4)
library(nlme)</code></pre>
<p>The <code>lme4</code> package does not provide p-values for the models. Some explanation on why by the author of the package, can be found <a href="https://stat.ethz.ch/pipermail/r-help/2006-May/094765.html">here</a>. The package <code>lmerTest</code> will provide you with p-values, however caution is needed in interpreting them!</p>
<p>The dataset for the example is <code>Orthodont</code></p>
<pre class="r"><code>data(Orthodont)
head(Orthodont)</code></pre>
<pre><code>## Grouped Data: distance ~ age | Subject
##   distance age Subject  Sex
## 1     26.0   8     M01 Male
## 2     25.0  10     M01 Male
## 3     29.0  12     M01 Male
## 4     31.0  14     M01 Male
## 5     21.5   8     M02 Male
## 6     22.5  10     M02 Male</code></pre>
<pre class="r"><code>dim(Orthodont)</code></pre>
<pre><code>## [1] 108   4</code></pre>
<p>The dataset consists of 108 observations, from 27 different subjects. The below code, calculates the number of unique values for each variable.</p>
<pre class="r"><code>sapply(Orthodont, function(x) length(unique(x)))</code></pre>
<pre><code>## distance      age  Subject      Sex 
##       27        4       27        2</code></pre>
<p>We can also see that there are 4 ages at which the distances are measured and two sexes.</p>
</div>
<div id="visualize-longitudinal-data" class="section level3">
<h3>Visualize longitudinal data</h3>
<p>A good way to visualize longitudinal data is with a spaghetti plot. Measurements from the same subject are connected with a line.</p>
<pre class="r"><code>library(ggplot2)
p &lt;- ggplot(data = Orthodont) +
  geom_point(aes(x = age, y = distance, group = Subject, colour = Sex)) +
  geom_line(aes(x = age, y = distance, group = Subject, colour = Sex)) +
  theme_classic() 
p</code></pre>
<p><img src="LearnR2_files/figure-html/unnamed-chunk-20-1.png" width="672" /></p>
<p>Based on the plot, overall the subjects seem to increase as age increases and Males seem to have a higher distance than Females.</p>
</div>
<div id="fit-the-model" class="section level3">
<h3>Fit the model</h3>
<p>We fit the mixed effects model, for which the code is similar to a linear regression model. In the fixed effect, we include age, sex and an interaction. In model <code>fm1</code> we estimate random intercepts with the code <code>(1 | Subject)</code>, allowing every subject their own intercept.</p>
<pre class="r"><code>fm1 &lt;- lmer(distance ~ age*Sex + (1 | Subject), data = Orthodont) </code></pre>
<p>With the summary command the results of the model can be obtained.</p>
<pre class="r"><code>summary(fm1)</code></pre>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: distance ~ age * Sex + (1 | Subject)
##    Data: Orthodont
## 
## REML criterion at convergence: 433.8
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -3.5980 -0.4546  0.0158  0.5024  3.6862 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  Subject  (Intercept) 3.299    1.816   
##  Residual             1.922    1.386   
## Number of obs: 108, groups:  Subject, 27
## 
## Fixed effects:
##               Estimate Std. Error t value
## (Intercept)    16.3406     0.9813  16.652
## age             0.7844     0.0775  10.121
## SexFemale       1.0321     1.5374   0.671
## age:SexFemale  -0.3048     0.1214  -2.511
## 
## Correlation of Fixed Effects:
##             (Intr) age    SexFml
## age         -0.869              
## SexFemale   -0.638  0.555       
## age:SexFeml  0.555 -0.638 -0.869</code></pre>
<p>The output provides us with both the random effects, which are estimators of the variance of each random effect (+possible covariances between random effects), and the fixed effects. The fixed effects are the population estimators and can be interpreted similar to the output of a linear regression model.</p>
</div>
<div id="compare-two-models" class="section level3">
<h3>Compare two models</h3>
<p>In model <code>fm2</code> we additionally include random slopes with <code>(age | Subject)</code>.</p>
<pre class="r"><code>fm2 &lt;- lmer(distance ~ age*Sex + (age | Subject), data = Orthodont) </code></pre>
<p>With the `<code>anova()</code> function we can compare the models to see which model provides a better fit of the data</p>
<pre class="r"><code>anova(fm1, fm2)</code></pre>
<pre><code>## Data: Orthodont
## Models:
## fm1: distance ~ age * Sex + (1 | Subject)
## fm2: distance ~ age * Sex + (age | Subject)
##     npar    AIC    BIC  logLik deviance  Chisq Df Pr(&gt;Chisq)
## fm1    6 440.64 456.73 -214.32   428.64                     
## fm2    8 443.81 465.26 -213.90   427.81 0.8331  2     0.6593</code></pre>
<p>From the AIC measure (smaller is better) we conclude that the random intercepts model provides a better fit of the data.</p>
</div>
<div id="evaluate-the-residuals" class="section level3">
<h3>Evaluate the residuals</h3>
<p>An important assumption of the mixed model is the normality of the residuals. They can be evaluated with the following code:</p>
<pre class="r"><code>model &lt;- fm1

par(mfrow = c(2,2))

# Are the residuals random noise?
residuals &lt;- resid(model)
plot(fitted(model), residuals)
abline(0,0)

# Is the response variable a reasonable linear function
# of the fitted values?
plot(fitted(model), Orthodont$distance)

# Are the residuals normally distributed?
qqnorm(residuals)
qqline(residuals)
hist(residuals)</code></pre>
<p><img src="LearnR2_files/figure-html/unnamed-chunk-25-1.png" width="672" /></p>
<p>There is a slight deviation from normality in the tails of the residuals, but not too much.</p>
</div>
<div id="make-predictions-and-an-effect-plot" class="section level3">
<h3>Make predictions and an effect plot</h3>
<p>We can make an effect plot to visualize the model. First we make a data set with the different levels of the covariates called <code>newdat</code></p>
<pre class="r"><code>newdat &lt;- expand.grid(age = c(8,10,12,14), 
                      Sex = c(&quot;Male&quot;, &quot;Female&quot;))</code></pre>
<p>Then we predict the model on this new data set. To obtain standard errors, the package <code>AICcmodavg</code> is used. The option <code>level = 0</code> indicates that we are making population level predictions.</p>
<pre class="r"><code>library(AICcmodavg)
pred &lt;- as.data.frame(predictSE(fm1, newdata = newdat, se.fit = TRUE, level = 0,
                                print.matrix = T))</code></pre>
<p>We can add the predictions to he <code>newdat</code> data set and calculate 95% confidence intervals</p>
<pre class="r"><code>newdat$pred &lt;- pred$fit

# Get the lower and upper confidence intervals
newdat$LO &lt;- pred$fit - 1.96 * pred$se.fit
newdat$HI &lt;- pred$fit + 1.96 * pred$se.fit
newdat$se &lt;- pred$se.fit</code></pre>
<p>This is how the first 6 rows of <code>newdat</code> look like now.</p>
<pre class="r"><code>head(newdat)</code></pre>
<pre><code>##   age    Sex     pred       LO       HI        se
## 1   8   Male 22.61563 21.55967 23.67158 0.5387528
## 2  10   Male 24.18438 23.21978 25.14897 0.4921414
## 3  12   Male 25.75313 24.78853 26.71772 0.4921414
## 4  14   Male 27.32187 26.26592 28.37783 0.5387528
## 5   8 Female 21.20909 19.93556 22.48262 0.6497603
## 6  10 Female 22.16818 21.00483 23.33153 0.5935449</code></pre>
<p>These predicted values can be added to the spaghettiplot made earlier</p>
<pre class="r"><code>p &lt;- ggplot(data = Orthodont) +
    geom_point(aes(x = age, y = distance, group = Subject, colour = Sex)) +
    geom_line(aes(x = age, y = distance, group = Subject, colour = Sex)) +
    geom_line(data = newdat, aes(x = age, y = pred, colour = Sex),  lwd = 2) +
    geom_ribbon(data = newdat, aes(x = age, ymin = LO, ymax = HI, fill = Sex),  alpha = 0.25) +
    theme_classic() 
p</code></pre>
<p><img src="LearnR2_files/figure-html/unnamed-chunk-30-1.png" width="672" /> From the plot is each clear that the average trajectory of males is slightly higher than females. The lines run almost parallel, but the males seem to be growing slightly faster.</p>
<p>With the package <code>lmerTest</code> p-values are added to the summary of the model.</p>
<pre class="r"><code>library(lmerTest)</code></pre>
<pre class="r"><code>fm1 &lt;- lmer(distance ~ age*Sex + (1 | Subject), data = Orthodont) 
summary(fm1)</code></pre>
<pre><code>## Linear mixed model fit by REML. t-tests use Satterthwaite&#39;s method [
## lmerModLmerTest]
## Formula: distance ~ age * Sex + (1 | Subject)
##    Data: Orthodont
## 
## REML criterion at convergence: 433.8
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -3.5980 -0.4546  0.0158  0.5024  3.6862 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  Subject  (Intercept) 3.299    1.816   
##  Residual             1.922    1.386   
## Number of obs: 108, groups:  Subject, 27
## 
## Fixed effects:
##               Estimate Std. Error       df t value Pr(&gt;|t|)    
## (Intercept)    16.3406     0.9813 103.9864  16.652  &lt; 2e-16 ***
## age             0.7844     0.0775  79.0000  10.121 6.44e-16 ***
## SexFemale       1.0321     1.5374 103.9864   0.671   0.5035    
## age:SexFemale  -0.3048     0.1214  79.0000  -2.511   0.0141 *  
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation of Fixed Effects:
##             (Intr) age    SexFml
## age         -0.869              
## SexFemale   -0.638  0.555       
## age:SexFeml  0.555 -0.638 -0.869</code></pre>
<p>At baseline there is no significant difference between males and females. Age is significant, meaning that overall subjects increase with age. The significant interaction denotes the deviation in parallel line seen in the graph.</p>
</div>
<div id="test-contrasts" class="section level3">
<h3>Test contrasts</h3>
<p>The package <code>emmeans</code> can be used to test contrasts and estimate marginal means.</p>
<pre class="r"><code>library(emmeans)</code></pre>
<p>Examples of use of the package are:</p>
<ol style="list-style-type: decimal">
<li>Compare the difference between male and female at all levels of age</li>
</ol>
<pre class="r"><code>emmeans(fm1, specs = pairwise ~  Sex | age, at = list(age = c(8, 10, 12, 14)))$contrasts</code></pre>
<pre><code>## age =  8:
##  contrast      estimate    SE   df t.ratio p.value
##  Male - Female     1.41 0.844 37.1 1.666   0.1041 
## 
## age = 10:
##  contrast      estimate    SE   df t.ratio p.value
##  Male - Female     2.02 0.771 26.3 2.615   0.0146 
## 
## age = 12:
##  contrast      estimate    SE   df t.ratio p.value
##  Male - Female     2.63 0.771 26.3 3.406   0.0021 
## 
## age = 14:
##  contrast      estimate    SE   df t.ratio p.value
##  Male - Female     3.24 0.844 37.1 3.833   0.0005 
## 
## Degrees-of-freedom method: kenward-roger</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>Estimate the marginal means of males and female at age = 10</li>
</ol>
<pre class="r"><code>emmeans(fm1, specs = pairwise ~  Sex | age, at = c(age = 10))$emmeans</code></pre>
<pre><code>## age = 10:
##  Sex    emmean    SE   df lower.CL upper.CL
##  Male     24.2 0.492 26.3     23.2     25.2
##  Female   22.2 0.594 26.3     20.9     23.4
## 
## Degrees-of-freedom method: kenward-roger 
## Confidence level used: 0.95</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Compare the overall value at age 12 with age 14:</li>
</ol>
<pre class="r"><code>emmeans(fm1, specs = pairwise ~  age , at = list(age = c(12, 14)))$contrasts</code></pre>
<pre><code>##  contrast estimate    SE df t.ratio p.value
##  12 - 14     -1.26 0.121 79 -10.409 &lt;.0001 
## 
## Results are averaged over the levels of: Sex 
## Degrees-of-freedom method: kenward-roger</code></pre>
<ol start="4" style="list-style-type: decimal">
<li>Estimate the marginal means at age 8 and 14 for males and females</li>
</ol>
<pre class="r"><code>emmeans(fm1, specs = pairwise ~  age | Sex, at = list(age = c(8, 14)))$emmeans</code></pre>
<pre><code>## Sex = Male:
##  age emmean    SE   df lower.CL upper.CL
##    8   22.6 0.539 37.1     21.5     23.7
##   14   27.3 0.539 37.1     26.2     28.4
## 
## Sex = Female:
##  age emmean    SE   df lower.CL upper.CL
##    8   21.2 0.650 37.1     19.9     22.5
##   14   24.1 0.650 37.1     22.8     25.4
## 
## Degrees-of-freedom method: kenward-roger 
## Confidence level used: 0.95</code></pre>
</div>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
